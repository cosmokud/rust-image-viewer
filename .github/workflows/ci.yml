name: Nightly Build

on:
  workflow_dispatch:

jobs:
  nightly:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GStreamer
        id: setup_gstreamer
        uses: blinemedical/setup-gstreamer@v1.4.0
        with:
          version: "1.27.90"
          arch: "x86_64"
          msiUrl: https://gstreamer.freedesktop.org/data/pkg/windows/1.27.90/msvc/gstreamer-1.0-msvc-x86-1.27.90.msi
          devMsiUrl: https://gstreamer.freedesktop.org/data/pkg/windows/1.27.90/msvc/gstreamer-1.0-devel-msvc-x86_64-1.27.90.msi

      - name: Install Rust (MSVC)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable-x86_64-pc-windows-msvc

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Build (release)
        shell: pwsh
        run: cargo build --release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-image-viewer-nightly
          path: target/release/rust-image-viewer.exe

      - name: Delete existing nightly release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $release = gh release view nightly 2>&1
          if ($LASTEXITCODE -eq 0) {
            gh release delete nightly -y --cleanup-tag
          }
          $global:LASTEXITCODE = 0

      - name: Create nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Nightly Build
          prerelease: true
          files: target/release/rust-image-viewer.exe
          body: |
            Automated nightly build from the latest commit.

            **Note:** This build requires GStreamer to be installed on your system.
            Download GStreamer from: https://gstreamer.freedesktop.org/download/
